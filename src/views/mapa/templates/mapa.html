{% extends 'base.html' %}

{% block content %}
<div class="container-fluid py-5 bg-light">
    <div class="container bg-white rounded shadow p-4">
        <h2 class="mb-4">Mapa de Conflictos Geopolíticos</h2>
        <div id="map" class="rounded border shadow-sm" style="height: 600px;"></div>
    </div>
</div>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""/>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>

<pre> {{ mapa.get_paises_afectados() }} </pre>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        var map = L.map('map').setView([20, 0], 2);

        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);

        // Lista dinámica de países afectados desde Flask
        const conflictos = {{ mapa.conflictos | tojson | safe }};

    fetch("{{ url_for('mapa.static', filename='countries.geojson') }}")
    .then(res => res.json())
    .then(data => {
        Object.values(conflictos).forEach(conflicto => {
            L.geoJSON(data, {
                filter: feature => conflicto.paises.includes(feature.properties.name),
                style: {
                    color: conflicto.color,
                    fillColor: conflicto.fillColor,
                    fillOpacity: 0.4,
                    weight: 2
                },
                onEachFeature: function (feature, layer) {
                    layer.bindPopup(`
                        <strong>Conflicto:</strong> ${conflicto.nombre}<br>
                        <strong>País:</strong> ${feature.properties.name}
                    `);
                }
            }).addTo(map);
        });
    })
});
</script>
{% endblock %}
